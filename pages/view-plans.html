<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Plans - Smart Study Planner</title>
    
    <!-- Favicon -->
     <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/responsive.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Navigation Header -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-graduation-cap"></i>
                <span>Smart Study Planner</span>
            </div>
            <div class="nav-menu">
                <a href="../index.html" class="nav-link">Home</a>
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="create-plan.html" class="nav-link">Create Plan</a>
                <a href="view-plans.html" class="nav-link active">All Plans</a>
                <a href="settings.html" class="nav-link">Settings</a>
            </div>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="view-plans-main">
        <div class="container">
            <!-- Page Header -->
            <header class="page-header">
                <div class="header-content">
                    <h1 class="page-title">
                        <i class="fas fa-list"></i>
                        All Study Plans
                    </h1>
                    <p class="page-subtitle">
                        Manage and track all your study plans in one place. View progress, edit plans, and stay organized.
                    </p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="window.location.href='create-plan.html'">
                        <i class="fas fa-plus"></i>
                        New Plan
                    </button>
                    <div class="view-toggle">
                        <button class="view-btn active" id="gridViewBtn" onclick="switchView('grid')">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="view-btn" id="listViewBtn" onclick="switchView('list')">
                            <i class="fas fa-list"></i>
                        </button>
                        <button class="view-btn" id="timelineViewBtn" onclick="switchView('timeline')">
                            <i class="fas fa-chart-line"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Filters and Search -->
            <section class="filters-section">
                <div class="filters-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search study plans..." 
                            oninput="handleSearch(this.value)"
                        >
                        <button class="search-clear" id="clearSearch" onclick="clearSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="filter-controls">
                        <select id="statusFilter" class="filter-select" onchange="applyFilters()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="draft">Draft</option>
                            <option value="paused">Paused</option>
                        </select>
                        
                        <select id="priorityFilter" class="filter-select" onchange="applyFilters()">
                            <option value="all">All Priorities</option>
                            <option value="high">High Priority</option>
                            <option value="medium">Medium Priority</option>
                            <option value="low">Low Priority</option>
                        </select>
                        
                        <select id="subjectFilter" class="filter-select" onchange="applyFilters()">
                            <option value="all">All Subjects</option>
                            <option value="computer-science">Computer Science</option>
                            <option value="mathematics">Mathematics</option>
                            <option value="physics">Physics</option>
                            <option value="chemistry">Chemistry</option>
                            <option value="biology">Biology</option>
                            <option value="engineering">Engineering</option>
                            <option value="cybersecurity">Cybersecurity</option>
                            <option value="other">Other</option>
                        </select>
                        
                        <select id="sortBy" class="filter-select" onchange="applySorting()">
                            <option value="recent">Recently Updated</option>
                            <option value="deadline">By Deadline</option>
                            <option value="priority">By Priority</option>
                            <option value="progress">By Progress</option>
                            <option value="alphabetical">Alphabetical</option>
                            <option value="created">Date Created</option>
                        </select>
                        
                        <button class="filter-btn" id="dueSoonFilter" onclick="toggleDueSoonFilter()">
                            <i class="fas fa-clock"></i>
                            Due Soon
                        </button>
                        
                        <button class="filter-btn" onclick="resetFilters()">
                            <i class="fas fa-undo"></i>
                            Reset
                        </button>
                    </div>
                </div>
            </section>

            <!-- Plans Summary -->
            <section class="summary-section">
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="summary-content">
                            <h3 id="totalPlans">0</h3>
                            <p>Total Plans</p>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon active">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="summary-content">
                            <h3 id="activePlans">0</h3>
                            <p>Active Plans</p>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon completed">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="summary-content">
                            <h3 id="completedPlans">0</h3>
                            <p>Completed</p>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon warning">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="summary-content">
                            <h3 id="overduePlans">0</h3>
                            <p>Overdue</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Plans Display Area -->
            <section class="plans-display-section">
                <!-- Grid View -->
                <div id="gridView" class="plans-grid active-view">
                    <!-- Plans will be dynamically loaded here -->
                </div>
                
                <!-- List View -->
                <div id="listView" class="plans-list">
                    <!-- Plans will be dynamically loaded here -->
                </div>
                
                <!-- Timeline View -->
                <div id="timelineView" class="plans-timeline">
                    <!-- Timeline will be dynamically loaded here -->
                </div>
                
                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3 class="empty-state-title">No Plans Found</h3>
                    <p class="empty-state-description" id="emptyStateMessage">
                        Try adjusting your filters or create a new study plan.
                    </p>
                    <button class="btn btn-primary" onclick="resetFilters()">
                        <i class="fas fa-undo"></i>
                        Clear Filters
                    </button>
                </div>

                <!-- No Plans State -->
                <div class="empty-state" id="noPlansState" style="display: none;">
                    <div class="empty-state-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <h3 class="empty-state-title">No Study Plans Yet</h3>
                    <p class="empty-state-description">
                        Get started by creating your first study plan to organize your learning goals.
                    </p>
                    <button class="btn btn-primary" onclick="window.location.href='create-plan.html'">
                        <i class="fas fa-plus"></i>
                        Create Your First Plan
                    </button>
                </div>
            </section>

            <!-- Bulk Actions -->
            <section class="bulk-actions-section" id="bulkActions" style="display: none;">
                <div class="bulk-actions-bar">
                    <div class="selected-count">
                        <span id="selectedCount">0</span> plans selected
                    </div>
                    <div class="bulk-buttons">
                        <button class="btn btn-secondary" onclick="bulkMarkComplete()">
                            <i class="fas fa-check"></i>
                            Mark Complete
                        </button>
                        <button class="btn btn-secondary" onclick="bulkMarkActive()">
                            <i class="fas fa-play"></i>
                            Mark Active
                        </button>
                        <button class="btn btn-secondary" onclick="bulkExport()">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                        <button class="btn" style="background-color: var(--error); color: var(--white);" onclick="bulkDelete()">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                        <button class="btn btn-secondary" onclick="clearSelection()">
                            <i class="fas fa-times"></i>
                            Clear
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Plan Details Modal -->
    <div class="modal-overlay" id="planDetailsModal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3 class="modal-title">Study Plan Details</h3>
                <button class="modal-close" onclick="closePlanDetails()">&times;</button>
            </div>
            <div class="modal-body" id="planDetailsBody">
                <!-- Plan details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePlanDetails()">Close</button>
                <button class="btn btn-secondary" id="editPlanFromModal">
                    <i class="fas fa-edit"></i>
                    Edit Plan
                </button>
                <button class="btn btn-primary" id="viewTimelineBtn">
                    <i class="fas fa-chart-line"></i>
                    View Timeline
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Actions Modal -->
    <div class="modal-overlay" id="quickActionsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Quick Actions</h3>
                <button class="modal-close" onclick="studyApp.closeModal('quickActionsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="quick-actions-grid">
                    <button class="quick-action-btn" onclick="quickMarkComplete()">
                        <i class="fas fa-check-circle"></i>
                        <span>Mark Complete</span>
                    </button>
                    <button class="quick-action-btn" onclick="quickPausePlan()">
                        <i class="fas fa-pause"></i>
                        <span>Pause Plan</span>
                    </button>
                    <button class="quick-action-btn" onclick="quickDuplicatePlan()">
                        <i class="fas fa-copy"></i>
                        <span>Duplicate</span>
                    </button>
                    <button class="quick-action-btn" onclick="quickExportPlan()">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                    </button>
                    <button class="quick-action-btn" onclick="quickSharePlan()">
                        <i class="fas fa-share"></i>
                        <span>Share</span>
                    </button>
                    <button class="quick-action-btn danger" onclick="quickDeletePlan()">
                        <i class="fas fa-trash"></i>
                        <span>Delete</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Delete Confirmation -->
    <div class="modal-overlay" id="bulkDeleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Bulk Delete</h3>
                <button class="modal-close" onclick="studyApp.closeModal('bulkDeleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <span id="deleteCount">0</span> selected study plans?</p>
                <p><strong>This action cannot be undone.</strong></p>
                <div class="plans-to-delete" id="plansToDelete">
                    <!-- List of plans to be deleted -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="studyApp.closeModal('bulkDeleteModal')">Cancel</button>
                <button class="btn" style="background-color: var(--error); color: var(--white);" onclick="confirmBulkDelete()">
                    <i class="fas fa-trash"></i>
                    Delete Plans
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner-large"></div>
            <p class="loading-text">Loading study plans...</p>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="../js/app.js"></script>
    <script src="../js/localStorage.js"></script>
    <script src="../js/studyPlan.js"></script>
    <script src="../js/timeline.js"></script>
    <script src="../js/notifications.js"></script>
    <script>
        // Global variables
        let currentView = 'grid';
        let filteredPlans = [];
        let selectedPlans = new Set();
        let currentFilters = {
            search: '',
            status: 'all',
            priority: 'all',
            subject: 'all',
            dueSoon: false
        };
        let currentSort = 'recent';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('View Plans page loaded');
            initializeViewPlans();
        });

        // Initialize view plans functionality
        function initializeViewPlans() {
            loadAllPlans();
            setupEventListeners();
            updateSummary();
        }

        // Load all study plans
        function loadAllPlans() {
            showLoading(true);
            
            setTimeout(() => {
                const allPlans = studyApp.studyPlans || [];
                filteredPlans = [...allPlans];
                
                if (allPlans.length === 0) {
                    showNoPlansState();
                } else {
                    hideNoPlansState();
                    applySorting();
                    renderPlans();
                }
                
                updateSummary();
                showLoading(false);
            }, 500);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 'f':
                            e.preventDefault();
                            document.getElementById('searchInput').focus();
                            break;
                        case 'n':
                            e.preventDefault();
                            window.location.href = 'create-plan.html';
                            break;
                        case 'a':
                            e.preventDefault();
                            if (e.shiftKey) {
                                selectAllPlans();
                            }
                            break;
                    }
                }
                
                if (e.key === 'Escape') {
                    clearSelection();
                }
            });
        }

        // Handle search input
        function handleSearch(query) {
            currentFilters.search = query.toLowerCase().trim();
            
            // Show/hide clear button
            const clearBtn = document.getElementById('clearSearch');
            clearBtn.style.display = query ? 'block' : 'none';
            
            applyFilters();
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentFilters.search = '';
            document.getElementById('clearSearch').style.display = 'none';
            applyFilters();
        }

        // Apply filters
        function applyFilters() {
            const allPlans = studyApp.studyPlans || [];
            
            filteredPlans = allPlans.filter(plan => {
                // Search filter
                if (currentFilters.search) {
                    const searchTerm = currentFilters.search;
                    const searchable = `${plan.title} ${plan.description} ${plan.subject}`.toLowerCase();
                    if (!searchable.includes(searchTerm)) return false;
                }
                
                // Status filter
                if (currentFilters.status !== 'all' && plan.status !== currentFilters.status) {
                    return false;
                }
                
                // Priority filter
                if (currentFilters.priority !== 'all' && plan.priority !== currentFilters.priority) {
                    return false;
                }
                
                // Subject filter
                if (currentFilters.subject !== 'all' && plan.subject !== currentFilters.subject) {
                    return false;
                }
                
                // Due soon filter
                if (currentFilters.dueSoon) {
                    const now = new Date();
                    const weekFromNow = new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000));
                    const deadline = new Date(plan.deadline);
                    if (!plan.deadline || deadline > weekFromNow || deadline < now) {
                        return false;
                    }
                }
                
                return true;
            });
            
            applySorting();
            renderPlans();
            updateSummary();
            
            // Show empty state if no results
            if (filteredPlans.length === 0) {
                showEmptyState();
            } else {
                hideEmptyState();
            }
        }

        // Apply sorting
        function applySorting() {
            const sortBy = document.getElementById('sortBy').value;
            
            filteredPlans.sort((a, b) => {
                switch (sortBy) {
                    case 'deadline':
                        if (!a.deadline) return 1;
                        if (!b.deadline) return -1;
                        return new Date(a.deadline) - new Date(b.deadline);
                        
                    case 'priority':
                        const priorityOrder = { high: 3, medium: 2, low: 1 };
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                        
                    case 'progress':
                        return (b.progress || 0) - (a.progress || 0);
                        
                    case 'alphabetical':
                        return a.title.localeCompare(b.title);
                        
                    case 'created':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                        
                    case 'recent':
                    default:
                        return new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt);
                }
            });
        }

        // Toggle due soon filter
        function toggleDueSoonFilter() {
            const filterBtn = document.getElementById('dueSoonFilter');
            currentFilters.dueSoon = !currentFilters.dueSoon;
            
            if (currentFilters.dueSoon) {
                filterBtn.classList.add('active');
            } else {
                filterBtn.classList.remove('active');
            }
            
            applyFilters();
        }

        // Reset filters
        function resetFilters() {
            // Reset filter values
            currentFilters = {
                search: '',
                status: 'all',
                priority: 'all',
                subject: 'all',
                dueSoon: false
            };
            
            // Reset form elements
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('priorityFilter').value = 'all';
            document.getElementById('subjectFilter').value = 'all';
            document.getElementById('dueSoonFilter').classList.remove('active');
            document.getElementById('clearSearch').style.display = 'none';
            
            applyFilters();
        }

        // Switch view
        function switchView(view) {
            // Update active button
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(view + 'ViewBtn').classList.add('active');
            
            // Hide all views
            document.querySelectorAll('.plans-grid, .plans-list, .plans-timeline').forEach(el => {
                el.classList.remove('active-view');
            });
            
            // Show selected view
            document.getElementById(view + 'View').classList.add('active-view');
            
            currentView = view;
            renderPlans();
        }

        // Render plans based on current view
        function renderPlans() {
            switch (currentView) {
                case 'grid':
                    renderGridView();
                    break;
                case 'list':
                    renderListView();
                    break;
                case 'timeline':
                    renderTimelineView();
                    break;
            }
        }

        // Render grid view
        function renderGridView() {
            const container = document.getElementById('gridView');
            
            if (filteredPlans.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = filteredPlans.map(plan => createPlanCard(plan)).join('');
            addPlanCardEventListeners();
        }

        // Render list view
        function renderListView() {
            const container = document.getElementById('listView');
            
            if (filteredPlans.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div class="list-header">
                    <div class="list-col select-col">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)">
                    </div>
                    <div class="list-col title-col">Title</div>
                    <div class="list-col progress-col">Progress</div>
                    <div class="list-col deadline-col">Deadline</div>
                    <div class="list-col priority-col">Priority</div>
                    <div class="list-col status-col">Status</div>
                    <div class="list-col actions-col">Actions</div>
                </div>
                ${filteredPlans.map(plan => createPlanListItem(plan)).join('')}
            `;
            
            addPlanListEventListeners();
        }

        // Render timeline view
        function renderTimelineView() {
            const container = document.getElementById('timelineView');
            
            if (filteredPlans.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            // Create timeline for each plan
            container.innerHTML = `
                <div class="timeline-header">
                    <h3>Study Plans Timeline</h3>
                    <p>Visual overview of all your study plans and their progress</p>
                </div>
                <div class="timelines-container">
                    ${filteredPlans.map(plan => `
                        <div class="plan-timeline-container" data-plan-id="${plan.id}">
                            <div class="timeline-plan-header">
                                <h4>${plan.title}</h4>
                                <span class="timeline-progress">${plan.progress || 0}% complete</span>
                            </div>
                            <div class="timeline-wrapper" id="timeline-${plan.id}"></div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Initialize timelines for each plan
            setTimeout(() => {
                filteredPlans.forEach(plan => {
                    const timelineContainer = document.getElementById(`timeline-${plan.id}`);
                    if (timelineContainer && window.timelineManager) {
                        window.timelineManager.createTimeline(plan.id, timelineContainer, {
                            compact: true,
                            showTasks: false,
                            interactive: true
                        });
                    }
                });
            }, 100);
        }

        // Create plan card for grid view
        function createPlanCard(plan) {
            const progress = plan.progress || 0;
            const isOverdue = plan.deadline && new Date(plan.deadline) < new Date() && plan.status !== 'completed';
            
            return `
                <div class="study-card ${isOverdue ? 'overdue' : ''}" data-plan-id="${plan.id}">
                    <div class="plan-select">
                        <input type="checkbox" class="plan-checkbox" value="${plan.id}" onchange="togglePlanSelection('${plan.id}', this.checked)">
                    </div>
                    <div class="card-header">
                        <h3 class="card-title" onclick="showPlanDetails('${plan.id}')">${plan.title}</h3>
                        <div class="card-badges">
                            <span class="card-priority ${plan.priority}">${plan.priority}</span>
                            <span class="card-status ${plan.status}">${plan.status}</span>
                        </div>
                    </div>
                    <p class="card-description">${plan.description || 'No description provided.'}</p>
                    <div class="card-progress">
                        <div class="progress-header">
                            <span class="progress-label">Progress</span>
                            <span class="progress-percentage">${progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    <div class="card-meta">
                        <div class="card-subject">
                            <i class="fas fa-tag"></i>
                            ${plan.subject || 'General'}
                        </div>
                        <div class="card-tasks">
                            <i class="fas fa-tasks"></i>
                            ${plan.tasks?.filter(t => t.completed).length || 0}/${plan.tasks?.length || 0} tasks
                        </div>
                    </div>
                    <div class="card-footer">
                        <span class="card-date ${isOverdue ? 'overdue' : ''}">
                            <i class="fas fa-calendar"></i>
                            ${isOverdue ? 'Overdue: ' : 'Due: '}${studyApp.formatRelativeDate(plan.deadline)}
                        </span>
                        <div class="card-actions">
                            <button class="btn-icon view" onclick="showPlanDetails('${plan.id}')" data-tooltip="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon edit" onclick="editPlan('${plan.id}')" data-tooltip="Edit Plan">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon more" onclick="showQuickActions('${plan.id}')" data-tooltip="More Actions">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create plan list item
        function createPlanListItem(plan) {
            const progress = plan.progress || 0;
            const isOverdue = plan.deadline && new Date(plan.deadline) < new Date() && plan.status !== 'completed';
            
            return `
                <div class="list-item ${isOverdue ? 'overdue' : ''}" data-plan-id="${plan.id}">
                    <div class="list-col select-col">
                        <input type="checkbox" class="plan-checkbox" value="${plan.id}" onchange="togglePlanSelection('${plan.id}', this.checked)">
                    </div>
                    <div class="list-col title-col">
                        <div class="plan-title" onclick="showPlanDetails('${plan.id}')">
                            <h4>${plan.title}</h4>
                            <p class="plan-subject">${plan.subject || 'General'}</p>
                        </div>
                    </div>
                    <div class="list-col progress-col">
                        <div class="progress-circle" style="--progress: ${progress}%">
                            <span>${progress}%</span>
                        </div>
                    </div>
                    <div class="list-col deadline-col">
                        <span class="${isOverdue ? 'text-error' : ''}">
                            ${studyApp.formatRelativeDate(plan.deadline)}
                        </span>
                    </div>
                    <div class="list-col priority-col">
                        <span class="priority-badge ${plan.priority}">${plan.priority}</span>
                    </div>
                    <div class="list-col status-col">
                        <span class="status-badge ${plan.status}">${plan.status}</span>
                    </div>
                    <div class="list-col actions-col">
                        <button class="btn-icon view" onclick="showPlanDetails('${plan.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon edit" onclick="editPlan('${plan.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon more" onclick="showQuickActions('${plan.id}')">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // Add event listeners to plan cards
        function addPlanCardEventListeners() {
            // Double-click to edit
            document.querySelectorAll('.study-card').forEach(card => {
                card.addEventListener('dblclick', (e) => {
                    if (!e.target.matches('input, button, .btn-icon')) {
                        const planId = card.dataset.planId;
                        editPlan(planId);
                    }
                });
            });
        }

        // Add event listeners to plan list items
        function addPlanListEventListeners() {
            // Similar event listeners for list view
            document.querySelectorAll('.list-item').forEach(item => {
                item.addEventListener('dblclick', (e) => {
                    if (!e.target.matches('input, button, .btn-icon')) {
                        const planId = item.dataset.planId;
                        editPlan(planId);
                    }
                });
            });
        }

        // Show plan details
        function showPlanDetails(planId) {
            const plan = studyApp.studyPlans.find(p => p.id === planId);
            if (!plan) return;
            
            const modalBody = document.getElementById('planDetailsBody');
            const progress = plan.progress || 0;
            const completedTasks = plan.tasks?.filter(t => t.completed).length || 0;
            const totalTasks = plan.tasks?.length || 0;
            
            modalBody.innerHTML = `
                <div class="plan-details-content">
                    <div class="plan-header">
                        <div class="plan-title-section">
                            <h2>${plan.title}</h2>
                            <div class="plan-badges">
                                <span class="badge priority ${plan.priority}">${plan.priority} priority</span>
                                <span class="badge status ${plan.status}">${plan.status}</span>
                                <span class="badge subject">${plan.subject || 'General'}</span>
                            </div>
                        </div>
                        <div class="plan-progress-section">
                            <div class="progress-circle large" style="--progress: ${progress}%">
                                <span>${progress}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="plan-info-grid">
                        <div class="info-item">
                            <label>Description</label>
                            <p>${plan.description || 'No description provided.'}</p>
                        </div>
                        <div class="info-item">
                            <label>Start Date</label>
                            <p>${studyApp.formatDate(plan.startDate)}</p>
                        </div>
                        <div class="info-item">
                            <label>Deadline</label>
                            <p>${studyApp.formatDate(plan.deadline)}</p>
                        </div>
                        <div class="info-item">
                            <label>Estimated Hours</label>
                            <p>${plan.estimatedHours || 0} hours</p>
                        </div>
                        <div class="info-item">
                            <label>Study Methods</label>
                            <p>${plan.methods?.join(', ') || 'Not specified'}</p>
                        </div>
                        <div class="info-item">
                            <label>Resources</label>
                            <p>${plan.resources || 'No resources listed'}</p>
                        </div>
                    </div>
                    
                    <div class="tasks-section">
                        <h3>Tasks (${completedTasks}/${totalTasks})</h3>
                        <div class="tasks-list">
                            ${plan.tasks?.map(task => `
                                <div class="task-item ${task.completed ? 'completed' : ''}">
                                    <input type="checkbox" ${task.completed ? 'checked' : ''} disabled>
                                    <span class="task-title">${task.title}</span>
                                    <span class="task-difficulty ${task.difficulty}">${task.difficulty}</span>
                                    <span class="task-hours">${task.estimatedHours}h</span>
                                </div>
                            `).join('') || '<p class="no-tasks">No tasks defined</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            // Setup modal buttons
            document.getElementById('editPlanFromModal').onclick = () => {
                editPlan(planId);
                closePlanDetails();
            };
            
            document.getElementById('viewTimelineBtn').onclick = () => {
                // Switch to timeline view and highlight this plan
                closePlanDetails();
                switchView('timeline');
                setTimeout(() => {
                    const planTimeline = document.querySelector(`[data-plan-id="${planId}"]`);
                    if (planTimeline) {
                        planTimeline.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        planTimeline.classList.add('highlight');
                        setTimeout(() => {
                            planTimeline.classList.remove('highlight');
                        }, 2000);
                    }
                }, 500);
            };
            
            studyApp.openModal('planDetailsModal');
        }

        // Close plan details
        function closePlanDetails() {
            studyApp.closeModal('planDetailsModal');
        }

        // Edit plan
        function editPlan(planId) {
            window.location.href = `create-plan.html?edit=${planId}`;
        }

        // Show quick actions
        function showQuickActions(planId) {
            window.currentActionPlanId = planId;
            studyApp.openModal('quickActionsModal');
        }

        // Quick action functions
        function quickMarkComplete() {
            const planId = window.currentActionPlanId;
            const plan = studyApp.studyPlans.find(p => p.id === planId);
            if (plan) {
                plan.status = 'completed';
                plan.progress = 100;
                plan.completedAt = new Date().toISOString();
                studyApp.saveToStorage();
                studyApp.showNotification('Plan marked as complete!', 'success');
                loadAllPlans();
            }
            studyApp.closeModal('quickActionsModal');
        }

        function quickPausePlan() {
            const planId = window.currentActionPlanId;
            const plan = studyApp.studyPlans.find(p => p.id === planId);
            if (plan) {
                plan.status = 'paused';
                studyApp.saveToStorage();
                studyApp.showNotification('Plan paused', 'info');
                loadAllPlans();
            }
            studyApp.closeModal('quickActionsModal');
        }

        function quickDuplicatePlan() {
            const planId = window.currentActionPlanId;
            const plan = studyApp.studyPlans.find(p => p.id === planId);
            if (plan) {
                const newPlan = {
                    ...plan,
                    id: studyApp.generateId(),
                    title: plan.title + ' (Copy)',
                    status: 'draft',
                    progress: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    completedAt: null,
                    tasks: plan.tasks.map(task => ({
                        ...task,
                        id: studyApp.generateId(),
                        completed: false,
                        completedAt: null
                    }))
                };
                
                studyApp.studyPlans.push(newPlan);
                studyApp.saveToStorage();
                studyApp.showNotification('Plan duplicated successfully!', 'success');
                loadAllPlans();
            }
            studyApp.closeModal('quickActionsModal');
        }

        function quickExportPlan() {
            const planId = window.currentActionPlanId;
            const plan = studyApp.studyPlans.find(p => p.id === planId);
            if (plan) {
                const dataStr = JSON.stringify(plan, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${plan.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
                link.click();
                URL.revokeObjectURL(url);
                studyApp.showNotification('Plan exported successfully!', 'success');
            }
            studyApp.closeModal('quickActionsModal');
        }

        function quickSharePlan() {
            const planId = window.currentActionPlanId;
            const plan = studyApp.studyPlans.find(p => p.id === planId);
            if (plan && navigator.share) {
                navigator.share({
                    title: plan.title,
                    text: plan.description,
                    url: window.location.href + '?plan=' + planId
                });
            } else {
                // Fallback to clipboard
                const shareText = `Check out my study plan: ${plan.title}\n${plan.description}\n${window.location.href}?plan=${planId}`;
                navigator.clipboard.writeText(shareText).then(() => {
                    studyApp.showNotification('Plan link copied to clipboard!', 'success');
                });
            }
            studyApp.closeModal('quickActionsModal');
        }

        function quickDeletePlan() {
            const planId = window.currentActionPlanId;
            if (confirm('Are you sure you want to delete this study plan? This action cannot be undone.')) {
                studyApp.studyPlans = studyApp.studyPlans.filter(p => p.id !== planId);
                studyApp.saveToStorage();
                studyApp.showNotification('Plan deleted successfully', 'success');
                loadAllPlans();
            }
            studyApp.closeModal('quickActionsModal');
        }

        // Selection functions
        function togglePlanSelection(planId, isSelected) {
            if (isSelected) {
                selectedPlans.add(planId);
            } else {
                selectedPlans.delete(planId);
            }
            
            updateBulkActions();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll(selectAll) {
            const checkboxes = document.querySelectorAll('.plan-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
                togglePlanSelection(checkbox.value, selectAll);
            });
        }

        function selectAllPlans() {
            filteredPlans.forEach(plan => selectedPlans.add(plan.id));
            document.querySelectorAll('.plan-checkbox').forEach(cb => cb.checked = true);
            updateBulkActions();
            updateSelectAllCheckbox();
        }

        function clearSelection() {
            selectedPlans.clear();
            document.querySelectorAll('.plan-checkbox').forEach(cb => cb.checked = false);
            updateBulkActions();
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                const totalVisible = document.querySelectorAll('.plan-checkbox').length;
                const selectedVisible = document.querySelectorAll('.plan-checkbox:checked').length;
                
                selectAllCheckbox.checked = totalVisible > 0 && selectedVisible === totalVisible;
                selectAllCheckbox.indeterminate = selectedVisible > 0 && selectedVisible < totalVisible;
            }
        }

        function updateBulkActions() {
            const bulkActionsSection = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedPlans.size > 0) {
                bulkActionsSection.style.display = 'block';
                selectedCount.textContent = selectedPlans.size;
            } else {
                bulkActionsSection.style.display = 'none';
            }
        }

        // Bulk action functions
        function bulkMarkComplete() {
            selectedPlans.forEach(planId => {
                const plan = studyApp.studyPlans.find(p => p.id === planId);
                if (plan) {
                    plan.status = 'completed';
                    plan.progress = 100;
                    plan.completedAt = new Date().toISOString();
                }
            });
            
            studyApp.saveToStorage();
            studyApp.showNotification(`${selectedPlans.size} plans marked as complete!`, 'success');
            clearSelection();
            loadAllPlans();
        }

        function bulkMarkActive() {
            selectedPlans.forEach(planId => {
                const plan = studyApp.studyPlans.find(p => p.id === planId);
                if (plan) {
                    plan.status = 'active';
                }
            });
            
            studyApp.saveToStorage();
            studyApp.showNotification(`${selectedPlans.size} plans marked as active!`, 'success');
            clearSelection();
            loadAllPlans();
        }

        function bulkExport() {
            const selectedPlansData = Array.from(selectedPlans).map(planId => 
                studyApp.studyPlans.find(p => p.id === planId)
            ).filter(Boolean);
            
            const dataStr = JSON.stringify(selectedPlansData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `study_plans_export_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            studyApp.showNotification(`${selectedPlans.size} plans exported successfully!`, 'success');
            clearSelection();
        }

        function bulkDelete() {
            const deleteCount = selectedPlans.size;
            const plansToDelete = Array.from(selectedPlans).map(planId => 
                studyApp.studyPlans.find(p => p.id === planId)
            ).filter(Boolean);
            
            document.getElementById('deleteCount').textContent = deleteCount;
            document.getElementById('plansToDelete').innerHTML = plansToDelete.map(plan => `
                <div class="plan-to-delete">
                    <strong>${plan.title}</strong>
                    <span class="plan-subject">${plan.subject || 'General'}</span>
                </div>
            `).join('');
            
            studyApp.openModal('bulkDeleteModal');
        }

        function confirmBulkDelete() {
            const deleteCount = selectedPlans.size;
            
            studyApp.studyPlans = studyApp.studyPlans.filter(plan => 
                !selectedPlans.has(plan.id)
            );
            
            studyApp.saveToStorage();
            studyApp.showNotification(`${deleteCount} plans deleted successfully`, 'success');
            
            clearSelection();
            studyApp.closeModal('bulkDeleteModal');
            loadAllPlans();
        }

        // Update summary statistics
        function updateSummary() {
            const allPlans = studyApp.studyPlans || [];
            const now = new Date();
            
            const stats = {
                total: allPlans.length,
                active: allPlans.filter(p => p.status === 'active').length,
                completed: allPlans.filter(p => p.status === 'completed').length,
                overdue: allPlans.filter(p => 
                    p.deadline && 
                    new Date(p.deadline) < now && 
                    p.status !== 'completed'
                ).length
            };
            
            document.getElementById('totalPlans').textContent = stats.total;
            document.getElementById('activePlans').textContent = stats.active;
            document.getElementById('completedPlans').textContent = stats.completed;
            document.getElementById('overduePlans').textContent = stats.overdue;
        }

        // Show/hide states
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showEmptyState() {
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('noPlansState').style.display = 'none';
            
            // Update empty state message based on active filters
            const hasFilters = currentFilters.search || 
                              currentFilters.status !== 'all' || 
                              currentFilters.priority !== 'all' || 
                              currentFilters.subject !== 'all' || 
                              currentFilters.dueSoon;
            
            if (hasFilters) {
                document.getElementById('emptyStateMessage').textContent = 
                    'No plans match your current filters. Try adjusting your search criteria.';
            } else {
                document.getElementById('emptyStateMessage').textContent = 
                    'No study plans found.';
            }
        }

        function hideEmptyState() {
            document.getElementById('emptyState').style.display = 'none';
        }

        function showNoPlansState() {
            document.getElementById('noPlansState').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
        }

        function hideNoPlansState() {
            document.getElementById('noPlansState').style.display = 'none';
        }

        // Update filter controls based on form changes
        document.getElementById('statusFilter').addEventListener('change', function() {
            currentFilters.status = this.value;
            applyFilters();
        });

        document.getElementById('priorityFilter').addEventListener('change', function() {
            currentFilters.priority = this.value;
            applyFilters();
        });

        document.getElementById('subjectFilter').addEventListener('change', function() {
            currentFilters.subject = this.value;
            applyFilters();
        });
    </script>
</body>
</html>
